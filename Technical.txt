チャットはクライアント・サーバ、対戦はP2P。
ノウハウ零からどこまでいけるか絶賛こどもちゃれんじでした。

本当にLunaPortさまさまだぜ！
主幹部分の一部を参考にしたため、LunaPortがなければここまで完成できなかった。
お礼の一言でも言いたいんだが、Engrishが出来ないのでこっそり念波でも送っておく。
「押忍！ LunaPortの作者さん！ ありがとッス！」

一度は失敗した入力履歴があっさり実装できてしまった。
レベルアップですぜ おいらもせいちょうしたもんだ


・鯖の寿命
はたしてそこまで鯖を起動できる人が現れるのかどうかわからないが、一応寿命が存在する。
49.71 : パソコン起動から49.17日(2^32ms)経過すると、もれなく回線チェックに引っかかるため切断祭りが起きる。
16383 : 発行できるIDが16383までなので、それ以上の新規接続が出来なくなる。一応増やすことは可能。

心配しなくてもどちらか引っかかる前に、鯖がエラーで落ちるよ！


・各ファイルの説明
Form1.h        : メインスレッド担当。GUI関係は大体ここ。そろそろ詰め込みすぎて見づらくなってきた。
Form1.cpp      : ゲームやパケット等の別スレッド用の処理をいろいろ突っ込んである。
LunaPortMT.cpp : mainにグローバル変数を扱う関数が少し。グローバルの宣言はここ。
stdafx.h       : グローバル変数や、デバッグプロセスの改造コードなど。恐らく本来の使い道から外れてる。
startup.h      : 起動時のスタートアップダイアログ。オプションからお引越しして来た人が多数いる。
option.h       : オプション画面。タブを横につけてオサレにしようとして失敗したのはここだけの内緒。
option.cpp     : オプション画面からメインフォームに情報を伝達する必要が出てきたので追加。

個人的にインデントはスペース4派なんだけど、VCのエディタじゃ扱いにくいのでタブ4で。


・スレッド
メイン    : GUI担当。スレッドの制御をミスるとフリーズするのでわかりやすい。
パケット  : パケットの数だけスレが走っていると思われる。 非常に多忙すぎてエラーの生産地になっている。
Game      : 格ツクが動いているスレッド。多忙です。終了処理が大変なことになってる。
Versus    : 対戦前のやり取り担当。観戦も担当するはずだったが、それは↓に移住した。
Spectacle : 観戦用スレッド。Versusより移住してきた。いかに休めるかがポイント。
Sonar     : 回線の生死判定チェック。20秒間隔でソニックブームを放つ。

目を瞑っていると、だんだん糸が絡まっていく光景ががが……


・スレッド同期
Thread::SleepとThread::Interruputを使ってたんだけど、
Monitor::Enterに割り込んできやがったので修正。
マルチスレッドって怖いね。
今はMonitor::WaitとMonitor::Pulseを使ってる。
対戦前のやりとりでSleepとInterruputを使ってるのはそのときの名残で記念物。

Pulseの使い方を間違っていたでござる。
Enter中じゃないと使っちゃいけないのね。


・実装済み
格ツクの起動
リプレイ
チャット
ネット対戦
観戦
回線チェック
リプレイファイルの圧縮    <-   Newcomer!

リプレイファイルの圧縮に舐めてかかったら返り討ちにあったでござる。
ランレングスさん馬鹿にしてすみませんでした。
ちなみに圧縮方法は、ランレングスを２ラインにしたような感じです。
圧縮率は悪いけど、速度は速いんじゃなかろうか。


・一生付ける気のない機能
wis
パラメータの途中変更
フィルタやキック
対戦ソフトの確認
マクロ

初志貫徹！ 漢なら迷わず突き進め！


・用語
Server   : 仕事請負人。ふとくておおきな回線が必要になる。
Host     : ポートを開放したクライアントのこと。いい名称が思いつかない。下手に略すとエロくなる。
Client   : これに限らず、テスト環境がないためちゃんと機能するのかどうか調べられない。脳内テスト最高！

beta     : 自信を持ってお届けすることの出来る不安定なバージョン。なにやら安定しだしたので卒業。
ガイル   : 待ちガイルがいる、でお馴染みの某国軍人さん。何故か鯖のイメージがこの人に脳内変換される。
ザンギ   : 必然的に蔵のイメージはこの人になる。投げキャラの宿命ゆえ、接近するまでが勝負です。
@        : あっとおどろくまっちんぐさーば
カウチ   : 休憩しながら観戦している状態。飲み食いしながらのんびり観戦することができるが、これをすると太る。
あいさつ : デバッグモードをオンにすると良く目にする言葉。パケットが弾かれた時に表示される。
MT       : LunaPort Multi Thread の略ではない。いや、マルチスレッドだけど。
           Tにこれと言った意味はないのだが、Mは速攻で当てられてびびった。

・UDPホールパンチング
クライアント同士でもUDPパケットを送りあうと、
通信できるようになることが稀に良くあるらしい……ほんとか？ ←ほんとだった
ひとまず入室パケを受け取ったら『あいさつ』しておく。


・当たり判定とか
メモリ
1 : 0x00430100    INIから読み込み
2 : 0x0042470C    対戦中に参照するとこ

逆汗
0x00414C90    1 -> 2 にコピーしてるとこ

・WindowsSize 1x1
関数のアドレスは"004177CE"あたり

・タイマー
0x00430114 : iniから読み込んだ値
0x00470050 : タイム(FFFFFFFFで無限) time*100 - 1
0x00472B80 : 表示タイム

・HP
1P : 0x004DFC85 / 0x004DFC91
2P : 0x004EDCC4 / 0x004EDCD0

・ステータス
0x0047033E
0x004704BC

b00001 : しゃがみ
b00010 : 空中
b00100 : 攻撃
b01000 : やられ
b10000 : 攻撃判定あり

・ラウンド数
0x00430124 : ini
470044 : ラウンドカウント

 : ラウンド最大値
470048 P1最大ラウンド数

edx : P1勝利回数
esi : P2勝利回数
0040970A   > 8B15 6DFC4D00  MOV EDX,DWORD PTR DS:[4DFC6D]            ;  Case 386 of switch 004086F7
00409710   . A1 48004700    MOV EAX,DWORD PTR DS:[470048]
00409715   . 8B35 ACDC4E00  MOV ESI,DWORD PTR DS:[4EDCAC]
0040971B   . 3BD0           CMP EDX,EAX
0040971D   . 0F8D EA000000  JGE ヴァンガ.0040980D
00409723   . 3BF0           CMP ESI,EAX
00409725   . 0F8D E2000000  JGE ヴァンガ.0040980D

・その他
0x00424780 モード(ストーリーとかVSとか)


TODO
・RSAあたりでパケットを暗号
→今のところ、メンバー情報を送る時にだけ簡単なやつで代用中。生IPの垂れ流しだけはしてません
  というかソースを公開している以上、暗号もへったくれもないような

・サーバを介したクライアント間の対戦
→まともに対戦できそうにない気がするのでパスするかも

・ソースの整理
・マルチスレッド的な意味でやばそうなコードの改善
・デバッガ・デバッギ・デバッグ技術の習得。ゲとゴはないようだ
・この３つは永遠の課題
